# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1i_sCAgWqOO-qoafXZlO9WSYDO0gezj93
"""

# [ê³¼ì œ 1] Upstage AI Ambassador ì§€ì›ì ì œì¶œ ì½”ë“œ
# ì£¼ì œ : ë…¸ë…„ì¸µ ë° ì•½ìë¥¼ ìœ„í•œ ì‹¤ì‹œê°„ í‚¤ì˜¤ìŠ¤í¬ ì£¼ë¬¸ ë„ìš°ë¯¸
# ì‘ì„±ì : ì£¼ì˜ì§„

import requests
import json
import os
import textwrap
from openai import OpenAI

# ====================================================================
# [ì‚¬ìš© ê°€ì´ë“œ]
# 1. Upstage Consoleì—ì„œ ë°œê¸‰ë°›ì€ API Keyë¥¼ ì•„ë˜ ë³€ìˆ˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
# 2. ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼(ì˜ˆ: kiosk.jpg)ì„ ê°™ì€ í´ë”ì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
# ====================================================================

# 1. API í‚¤ ì„¤ì •
api_key = "YOUR_UPSTAGE_API_KEY_HERE"

# 2. ë¶„ì„í•  ì´ë¯¸ì§€ íŒŒì¼ëª… ì„¤ì •
filename = "/content/test_image1.jpg" # Colab í™˜ê²½ ê¸°ì¤€ ê²½ë¡œ

# 3. í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë„ˆë¹„ ì„¤ì • (ì›í•˜ëŠ” í¬ê¸°ë§Œí¼ ì„¤ì •)
USER_WIDTH = 40
AI_WIDTH = 60

# ===================================================================

client = OpenAI(api_key=api_key, base_url="https://api.upstage.ai/v1/solar")
layout_url = "https://api.upstage.ai/v1/document-ai/layout-analysis"
headers = {"Authorization": f"Bearer {api_key}"}

silver_persona = """
ë‹¹ì‹ ì€ í‚¤ì˜¤ìŠ¤í¬ ì‚¬ìš©ì´ ì–´ë ¤ìš´ ì–´ë¥´ì‹ ì„ ë•ëŠ” 'ì• ë‹ˆì› í†¡' ë¹„ì„œì…ë‹ˆë‹¤.
ë‹¤ìŒ ì›ì¹™ì„ ì§€ì¼œì£¼ì„¸ìš”:
1. ì¹œì ˆí•œ ìƒë‹´ì‚¬ ì²˜ëŸ¼ ì˜ˆì˜ ë°”ë¥´ê³  ë‹¤ì •í•˜ê²Œ ë§ì”€í•˜ì„¸ìš”. (~í•˜ì„¸ìš”, ~ì…ë‹ˆë‹¤)
2. ì–´ë ¤ìš´ ì™¸ë˜ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ê³ , ë©”ë‰´ì˜ ìœ„ì¹˜ë‚˜ ê°€ê²©ì„ ì •í™•íˆ ì•ˆë‚´í•˜ì„¸ìš”.
3. ë‹µë³€ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ í•µì‹¬ë§Œ ê°„ë‹¨íˆ ë§í•´ì£¼ì„¸ìš”.
"""

def silver_talk_start():
    print(f"ğŸš€ [ì• ë‹ˆì› í†¡] ì‹œìŠ¤í…œì„ ì‹œì‘í•©ë‹ˆë‹¤...")

    # Step 1 : ì´ë¯¸ì§€ ë¶„ì„ (Document Parse)
    if not os.path.exists(filename):
        print(f"âš ï¸ ê²½ê³ : '{filename}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸í•  ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return

    print(f"ğŸ‘€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤... (Document Parse API)")
    try:
        with open(filename, "rb") as f:
            response = requests.post(layout_url, headers=headers, files={"document": f})

        if response.status_code != 200:
            print(f"âŒ ë¶„ì„ ì‹¤íŒ¨: API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (í˜„ì¬ ì„¤ì •: {api_key[:5]}...)")
            return

        scan_result = json.dumps(response.json(), ensure_ascii=False)
        print("âœ… ì´ë¯¸ì§€ ë¶„ì„ ì™„ë£Œ! Solarê°€ ë‚´ìš©ì„ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤...\n")
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return

    # Step 2 : ìš”ì•½ ë° ì •ë¦¬ (Solar LLM)
        summary_prompt = """
    ì œê³µëœ JSON ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ:
    1. [ì¹œì ˆí•œ ìš”ì•½]: ì „ì²´ ë©”ë‰´ ì¢…ë¥˜ì™€ ê°€ì¥ ì €ë ´í•œ ë©”ë‰´ë¥¼ 3ì¤„ ë‚´ë¡œ ìš”ì•½í•´.
    2. [ë©”ë‰´íŒ ì •ë¦¬]: ë©”ë‰´ëª…ê³¼ ê°€ê²©ì„ ë§ˆí¬ë‹¤ìš´ í‘œë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´.
    """

    try:
        summary_response = client.chat.completions.create(
            model="solar-1-mini-chat",
            messages=[
                {"role": "system", "content": silver_persona},
                {"role": "user", "content": f"ë°ì´í„°: {scan_result}\n\n{summary_prompt}"}
            ]
        )
        menu_context = summary_response.choices[0].message.content

        print("="*60)
        print(f"ğŸ¤– [ì• ë‹ˆì› í†¡]: ì–´ë¥´ì‹ , ì‚¬ì§„ì„ ë³´ë‹ˆ ì´ëŸ° ë©”ë‰´ë“¤ì´ ìˆë„¤ìš”!\n")
        print(menu_context)
        print("="*60)
    except Exception as e:
        print(f"âŒ Solar ì—°ê²° ì‹¤íŒ¨: {e}")
        return

    # Step 3 : ëŒ€í™” ì‹œì‘ (Interaction)
    print("\nğŸ¤ ê¶ê¸ˆí•œ ê²Œ ìˆìœ¼ì‹œë©´ ë¬¼ì–´ë³´ì„¸ìš”! (ì¢…ë£Œí•˜ë ¤ë©´ 'ê·¸ë§Œ' ì…ë ¥)")

    chat_history = [
        {"role": "system", "content": silver_persona},
        {"role": "system", "content": f"ë©”ë‰´ ì •ë³´:\n{scan_result}"},
        {"role": "assistant", "content": menu_context}
    ]

    while True:
        try:
            user_input = input("\nğŸ“ ì§ˆë¬¸ ì…ë ¥: ")
            if user_input.strip() == "ê·¸ë§Œ":
                print("ğŸ¤– [ì• ë‹ˆì› í†¡]: ë„¤, ì¡°ì‹¬íˆ ë“¤ì–´ê°€ì„¸ìš”!")
                break

            print("\nğŸ‘µ [ì–´ë¥´ì‹ ]:")
            print(textwrap.fill(user_input, width=USER_WIDTH))

            chat_history.append({"role": "user", "content": user_input})

            answer_response = client.chat.completions.create(
                model="solar-1-mini-chat",
                messages=chat_history
            )

            ai_answer = answer_response.choices[0].message.content

            print("\nğŸ¤– [ì• ë‹ˆì› í†¡]:")
            print(textwrap.fill(ai_answer, width=AI_WIDTH))
            print("-" * AI_WIDTH)

            chat_history.append({"role": "assistant", "content": ai_answer})

        except KeyboardInterrupt:
            print("\nì¢…ë£Œí•©ë‹ˆë‹¤.")
            break

# ì‹¤í–‰ (API Keyê°€ ì„¤ì •ë˜ì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤)
if __name__ == "__main__":
    if api_key == "YOUR_UPSTAGE_API_KEY_HERE":
        print("âš ï¸ [ì•Œë¦¼] ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ 'api_key' ë³€ìˆ˜ì— ë³¸ì¸ì˜ API Keyë¥¼ ì…ë ¥ í›„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.")
    else:
        silver_talk_start()